---
title: "FEDUP: User Manual"
package: FEDUP
output: prettydoc::html_pretty
vignette: >
    %\VignetteIndexEntry{FEDUP: User Manual}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---

`FEDUP` is an R package that tests for enrichment and depletion
of user-defined pathways using a Fisher's exact test. This package is
designed for versatile pathway annotation formats (eg. gmt, txt, xlsx) to
allow the user to run pathway analysis on their annotations of choice.
FEDUP is also integrated with Cytoscape to provide network-based pathway
visualization that enhances the interpretability of enrichment results.

## Getting started
### System prerequisites

R version >= 4.0  
R packages:

* **CRAN**: openxlsx, tibble, dplyr, data.table, ggplot2, ggthemes, forcats,
            RColorBrewer  
* **Bioconductor**: RCy3

### Installation

Install FEDUP via devtools:

```{r, FEDUP_install, message = FALSE, warning = FALSE}
#devtools::install_github("rosscm/FEDUP")
devtools::load_all()
```

## Quick run
### Data input

Load example test genes, background genes, and pathways:

To note, the test genes comprise solely of a **muscle contraction** pathway
(Reactome ID 397014). So we would expect to see strong *enrichment* for pathways
related to muscle contraction and *depletion* for pathways not associated with
muscle contraction. Let's see!

```{r, FEDUP_input}
data(testGene)
data(backgroundGene)
data(pathwaysGMT)
```

Take a look at the data structure:

```{r, FEDUP_data_str}
str(testGene)
str(backgroundGene)
str(head(pathwaysGMT))
```

### Pathway analysis

Now run `FEDUP` on sample data:

```{r, FEDUP_run}
fedup_res <- runFedup(testGene, backgroundGene, pathwaysGMT)
```

View output results table sorted by pvalue:

```{r, FEDUP_results}
print(head(fedup_res[which(fedup_res$status == "Enriched"),]))
print(head(fedup_res[which(fedup_res$status == "Depleted"),]))
```

As expected, we see strong enrichment for muscle-related pathways and depletion
for functions not associated with muscle contraction, such as olfactory
signalling and amino acid metabolism). Nice!

### Visualization

Plot enriched and depleted pathways (qvalue < 0.05) in the form of a dot plot:

```{r, FEDUP_dotplot, fig.width = 9, fig.height = 9.5}
fedup_plot <- fedup_res[which(fedup_res$qvalue < 0.05),]
fedup_plot$log10qvalue <- -log10(fedup_plot$qvalue + 1e-10) # log10-transform qvalue for plotting
fedup_plot$pathway <- gsub("\\%.*", "", fedup_plot$pathway) # clean pathway names
p <- plotDotPlot(
  df = fedup_plot,
  x_var = "log10qvalue",
  y_var = "pathway",
  x_lab = "-log10(Qvalue)",
  fill_var = "status",
  fill_lab = "Enrichment\nstatus",
  size_var = "fold_enrichment",
  size_lab = "Fold enrichment")
p <- p + # facet by status to separate enriched and depleted pathways
  facet_grid("status", scales = "free", space = "free") +
  theme(strip.text.y = element_blank())
print(p)
```

Look at all those chick... enrichments! This is a bit overwhelming, no? How do
we interpret these *76* different pathways? What if we could visualize them
in a way that doesn't hurt our tired brains even more? Oh I know...
let's use an Enrichment Map!  

First, make sure to have [Cytoscape](https://cytoscape.org/download.html)
downloaded and and open on your computer. You'll also need to install the
[EnrichmentMap](http://apps.cytoscape.org/apps/enrichmentmap) and
[AutoAnnotate](http://apps.cytoscape.org/apps/autoannotate) apps.

Then format `FEDUP` results for compatibility with EnrichmentMap:

```{r, FEDUP_EM_prepare_results}
results_file <- tempfile("fedup_res", fileext = ".txt")
writeFemap(fedup_res, results_file)
```

Prepare a pathway annotation file (GMT format) from the pathway list you passed
to `FEDUP` (you don't need to run this function if your pathway annotations are
already in GMT format, but it doesn't hurt to make sure):

```{r, FEDUP_EM_prepare_gmt}
gmt_file <- tempfile("pathwaysGMT", fileext = ".gmt")
writePathways(pathwaysGMT, gmt_file)
```

Cytoscape is open right? If so, uncomment these lines and let the magic happen:

```{r, FEDUP_EM}
#net_file <- tempfile("FEDUP_EM", fileext = ".png")
#plotFemap(
#  gmt_file = gmt_file,
#  results_file = results_file,
#  qvalue = 0.05,
#  net_name = "FEDUP_EM",
#  net_file = net_file)
```

![](figures/FEDUP_EM-1.png)

After some manual rearrangement of the annotated pathway clusters, this is the
resulting Enrichment Map we get from our `FEDUP` results. Much better :)

This has effectively summarized the 76 pathways in our dot plot into 14 unique
biological themes (including 4 unclustered pathways). We can now see clear
themes in the data pertaining to muscle contraction, such as NMDA receptor
function, calcium homeostasis, and ATPase transport.

## Versioning

For the versions available, see the
[tags on this repo](https://github.com/rosscm/FEDUP/tags).
